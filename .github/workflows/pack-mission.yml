name: Build and Release PBO

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-pbo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG=${{ github.ref_name }}
          else
            TAG=$(curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              jq -r .tag_name)
          fi
          # Improved version formatting (v6.0.0-2025_build â†’ v6000)
          SIMPLIFIED_TAG="v$(echo "$TAG" | sed -E 's/^v//; s/\.//g; s/(-.*)//')"
          echo "simplified_version=$SIMPLIFIED_TAG" >> $GITHUB_OUTPUT
          echo "original_tag=$TAG" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}
          
      - name: Find mission folder
        id: mission-folder
        run: |
          MISSION_DIR=$(find . -maxdepth 1 -type d -name "*.*" ! -name ".*" | head -1)
          if [ -z "$MISSION_DIR" ] || [ "$MISSION_DIR" = "." ]; then
            echo "::error::Valid mission folder not found. Ensure there's a directory named like 'missionname.mapname'"
            exit 1
          fi
          CLEAN_DIR="${MISSION_DIR#./}"
          echo "directory=$CLEAN_DIR" >> $GITHUB_OUTPUT
          FILENAME=$(basename "$CLEAN_DIR" | cut -d. -f1)
          MAPNAME=$(basename "$CLEAN_DIR" | cut -d. -f2)
          echo "pbo_name=${FILENAME}_${{ steps.version.outputs.simplified_version }}.${MAPNAME}.pbo" >> $GITHUB_OUTPUT

      - name: Build PBO
        run: |
          mkdir -p output
          echo "ðŸ›  Building PBO from: ${{ steps.mission-folder.outputs.directory }}"
          
          # Build with modern PBO parameters
          docker run --rm -v "$(pwd):/data" jerryhopper/depbo-tools:latest \
            makepbo -P -X=".txt" -N "/data/${{ steps.mission-folder.outputs.directory }}" "/data/output" || true
          
          # Verify PBO creation using basename
          PBO_BASENAME=$(basename "${{ steps.mission-folder.outputs.directory }}")
          if [ ! -f "output/$PBO_BASENAME.pbo" ]; then
            echo "::error::PBO file was not created! Check mission file structure."
            exit 1
          fi


      - name: Rename PBO
        run: |
          mv "output/$(basename "${{ steps.mission-folder.outputs.directory }}").pbo" "${{ steps.mission-folder.outputs.pbo_name }}"

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.original_tag }}
          files: ${{ steps.mission-folder.outputs.pbo_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
